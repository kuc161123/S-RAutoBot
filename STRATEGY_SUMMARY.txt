================================================================================
TRADING STRATEGY IMPLEMENTATION ANALYSIS - EXECUTIVE SUMMARY
================================================================================

PROJECT: AutoTrading Bot for Bybit Perpetual Futures
TIMEFRAMES: 15-minute (main), 3-minute (scalp), 1H/4H (multi-timeframe support)
TOP SYMBOLS: 62 cryptocurrency pairs by market cap
TRADING MODES: 2 Active (Mean Reversion + Scalping), 1 Phantom-Only (Trend)

================================================================================
STRATEGY OVERVIEW
================================================================================

1. MEAN REVERSION STRATEGY (ENABLED - Execution Active)
   ────────────────────────────────────────────────────
   
   Entry Logic: Range-based mean reversion on 15m bars
   ├─ Phase 1: Identify valid ranges (2.5%-6.0% width)
   ├─ Phase 2: Wait for edge touch (≤0.5 ATR from boundary)
   ├─ Phase 3: Confirm reversal candle (bullish for LONG, bearish for SHORT)
   └─ Phase 4: Generate signal with hybrid 3-option SL calculation
   
   Stop Loss Method: Hybrid (Choose Most Conservative)
   ├─ Option 1: Range boundary - (0.3 × buffer × ATR)
   ├─ Option 2: Entry - (1.0 × buffer × ATR)
   └─ Option 3: Support/Resistance - (buffer × ATR)
   
   Volatility Adjustment:
   ├─ Normal (20-60th %ile): 1.0x
   ├─ Above Average (60-80th %ile): 1.2x
   ├─ High (>80th %ile): 1.4x
   └─ Low (<20th %ile): 0.8x
   
   Risk/Reward: Fixed 2.5:1 with fee adjustment (1.00165)
   Win Rate: 45-55% (typical)
   Setup Frequency: High (range touches multiple times per day)
   
   ML Features: 35+ (range quality, volatility, volume, trend, time-of-day)
   Phantom Timeout: 36 hours
   Execution Gates: Regime filter (block extreme volatility)
   
   Files:
   ├─ strategy_mean_reversion.py (Core logic)
   ├─ ml_scorer_mean_reversion.py (ML scoring)
   ├─ mr_phantom_tracker.py (Phantom tracking)
   └─ ml_qscore_range_adapter.py (Quality scoring)

2. SCALPING STRATEGY (ENABLED - Execution Active)
   ──────────────────────────────────────────────
   
   Entry Logic: EVWAP pullback + trend continuation on 3m bars
   ├─ Phase 1: Trend confirmation (EMA8 > EMA21 for LONG)
   ├─ Phase 2: Multi-anchor proximity (VWAP OR EMA OR BB within thresholds)
   ├─ Phase 3: Volume spike detection (1.2x 20-bar average for execution)
   ├─ Phase 4: Bollinger band width check (60th %ile for execution)
   └─ Phase 5: Wick/body rejection (dominant wick in trend direction)
   
   Stop Loss Method: Mean-Band Centered
   ├─ LONG: min(VWAP, EMA21) - 0.8-1.2x ATR
   └─ SHORT: max(VWAP, EMA21) + 0.8-1.2x ATR
   
   Buffer Multiplier (Volatility-Based):
   ├─ Low BBW (<70th %ile): 0.8x
   ├─ Normal BBW (70-85th %ile): 1.0x
   └─ High BBW (>85th %ile): 1.2x
   
   Risk/Reward: Fixed 2.1:1 (tighter than Trend/MR)
   Win Rate: 50-60% (data-driven from feature analysis)
   Setup Frequency: Very High (3m timeframe, multiple setups per hour)
   
   High-WR Bypass System:
   └─ 6 proven feature combinations (49-57% WR, N=538 total)
      Each: Fast Slope × Slow Slope × ATR% × BBW% × VWAP Distance
      Behavior: Instant execution, skips all gates, fixed 1% risk
   
   ML Features: 12 (atr_pct, bbw_pct, impulse_ratio, slopes, volume, wicks, etc)
   Phantom Timeout: 8 hours
   Execution Gates: Volume, BBW, Wick alignment, Regime, EMA slope (inverted)
   Off-Hours Block: Auto-detects low-volume periods (atr%, bbw%, vol%)
   
   Files:
   ├─ strategy_scalp.py (Core logic)
   ├─ ml_scorer_scalp.py (ML scoring)
   ├─ scalp_phantom_tracker.py (Phantom tracking)
   └─ ml_qscore_scalp_adapter.py (Quality scoring)

3. TREND PULLBACK STRATEGY (DISABLED - Phantom-Only Learning)
   ─────────────────────────────────────────────────────────
   
   Entry Logic: Zone-based S/R breakout + pullback confirmation on 15m bars
   ├─ Phase 1: S/R Detection (Pivot-based zones, 0.3% each side)
   ├─ Phase 2: Breakout (Close outside zone)
   ├─ Phase 3: Pullback Formation (HL/LH within zone)
   ├─ Phase 4: 2-Candle Confirmation (Direction-aligned candles)
   └─ Phase 5: Signal generation with hybrid 3-option SL
   
   Stop Loss Method: Hybrid (Same as MR - Most Conservative)
   ├─ Option 1: Previous Pivot - (0.3 × buffer × ATR)
   ├─ Option 2: Breakout Level - (1.6 × buffer × ATR)
   └─ Option 3: Pullback Extreme - (buffer × ATR)
   
   Risk/Reward: Fixed 2.5:1 with fee adjustment
   Win Rate: 55-65% (when enabled)
   Setup Frequency: Lower (fewer S/R breakouts than range touches)
   
   ML Features: 22 (trend strength, volume, ATR, structure, cluster, MTF, etc)
   Phantom Timeout: 168 hours (1 week)
   Execution Gates: S/R strength, HTF alignment, BTC gate, Regime filter
   
   Files:
   ├─ strategy_pullback_ml_learning.py (Core logic)
   ├─ ml_scorer_trend.py (ML scoring)
   ├─ phantom_trade_tracker.py (Phantom tracking)
   └─ ml_qscore_trend_adapter.py (Quality scoring)
   
   Current Status: Execution disabled (trend.exec.enabled: false)
   Reason: Passive learning mode - collecting phantom data for future training

================================================================================
ML SYSTEM ARCHITECTURE
================================================================================

Phantom Tracking:
├─ Records: Every signal generated (executed or rejected)
├─ Calculates: Full feature set for ML training
├─ Monitors: Outcome (TP hit, SL hit, timeout)
├─ Labels: As win/loss for supervised learning
└─ Serves: As ground truth for model training

ML Scoring Timeline:
├─ 0-50 trades: Learning phase (accept all signals)
├─ 50-200 trades: Heuristic scoring (simple rules)
├─ 200+ trades: ML model active (threshold 70+)

Quality Scoring (Qscore):
├─ Execution Tier (A): Qscore ≥ 78 → Execute immediately
├─ Learning Tier (B): 15 ≤ Qscore < 78 → Record as phantom
└─ Low Quality (C): Qscore < 15 → Downweight in training

Weighted Components (Strategy-Specific):
├─ Trend: SR(0.25) + HTF(0.30) + BOS(0.15) + Micro(0.10) + Risk(0.10) + Div(0.10)
├─ MR: Range(0.35) + FBO(0.25) + Proximity(0.15) + Micro(0.10) + Risk(0.10) + SR(0.05)
└─ Scalp: Momentum(0.35) + Pullback(0.20) + Micro(0.15) + HTF(0.10) + SR(0.10) + Risk(0.10)

Adaptive Flow Control:
├─ Daily Target: 200+ phantoms per strategy
├─ Relaxation: If below target, loosen thresholds
│  ├─ Trend: Reduce slope by 1.5 pct-pts, EMA stack by 15
│  ├─ MR: Reduce rc by 0.30, touches by 3
│  └─ Scalp: Increase VWAP distance by 0.60 ATR, reduce BBW by 0.30
└─ Win Rate Guard: Cap relaxation if recent WR < 40%

================================================================================
EXECUTION FLOW
================================================================================

Signal Generation (Per Kline):
1. Identify setup using strategy rules
2. Calculate features (22, 35+, or 12 depending on strategy)
3. Generate Signal object with entry, SL, TP, metadata

Phantom Recording (Immediate):
1. Store signal in phantom tracker
2. Set timeout (8-168 hours depending on strategy)
3. Track outcome monitoring

ML Scoring (If Model Ready):
1. If <200 total trades: Accept signal
2. If ≥200 trades: Score signal using trained model
3. If score < threshold: Skip execution (phantom only)
4. If score ≥ threshold: Proceed to gates

Rule-Mode Qscore:
1. Calculate weighted component scores
2. Combine into single Qscore (0-100)
3. Map to execution tier (A/B/C)
4. Use for execution arbitration

Execution Gates (Before Order):
1. Regime Check: Not extreme volatility
2. S/R Check (Trend only): Level strength valid
3. HTF Check: Higher timeframe alignment good
4. BTC Check (Trend only): BTC trend supportive
5. Volume Check: Spike above threshold
6. Volatility Check: ATR/BBW within bounds
7. Qscore Check: In execution tier

Order Placement (If All Gates Pass):
1. Calculate risk amount from equity and risk %
2. Calculate quantity = risk_amount / (entry - sl)
3. Place market entry order
4. Place SL + TP orders (Partial mode if enabled)
5. Update position tracking

Position Management:
1. Monitor fills and P&L
2. Update phantom with execution details
3. Track TP/SL hits
4. Close phantom with outcome (win/loss/timeout)
5. Label outcome for ML training
6. Retrain model if threshold met (50 trade interval)

================================================================================
CONFIGURATION CONTROL POINTS
================================================================================

Master Switches (config.yaml):
├─ scalp.enabled: true (Enable scalp strategy)
├─ scalp.exec.enabled: true (Allow execution)
├─ scalp.stream_3m_only: true (Use 3m bars)
├─ mr.exec.enabled: true (Allow MR execution)
└─ trend.exec.enabled: false (Disable Trend execution)

Gate Thresholds:
├─ ml_min_score: 70.0 (ML execution threshold)
├─ regime_enabled: true (Block extreme volatility)
├─ scalp.hard_gates.vol_enabled: true (Volume gate)
├─ scalp.hard_gates.bbw_exec_enabled: true (BB width gate)
└─ scalp.hard_gates.slope_enabled: true (EMA slope gate)

Phantom Flow:
├─ phantom_flow.enabled: true (Adaptive targets)
├─ phantom_flow.daily_target: 200 per strategy
└─ phantom_flow.relax_limits: Loosen if below target

Specific Parameters:
├─ MR: range_width (2.5%-6.0%), edge_touch (0.5 ATR)
├─ Scalp: ema_fast (8), ema_slow (21), atr_len (7)
├─ Scalp: vwap_window (100), bb_period (20)
├─ Scalp: vol_ratio (1.20 exec, 0.80 signal)
└─ Trend: pivot_left (3), pivot_right (2), zone_width (0.3%)

================================================================================
KEY PARAMETERS BY STRATEGY
================================================================================

Mean Reversion (15m):
├─ Range Width: 2.5%-6.0% (strict bounds)
├─ Edge Touch: ≤0.5 ATR
├─ Confirmation: Reversal candle (close)
├─ Stop Loss Buffer: 0.8x-1.4x ATR (volatility-adjusted)
├─ Take Profit: 2.5:1 with 0.165% fee compensation
├─ Phantom Timeout: 36 hours
└─ Execution Frequency: High (multiple ranges per day)

Scalping (3m):
├─ EMA Setup: 8/21 (fast > slow for LONG)
├─ VWAP Distance: 0.70 ATR (signal), 0.50 ATR (tight)
├─ Volume Ratio: 1.20x (execution), 0.80x (signal)
├─ BB Width: 60th %ile (execution), 55th %ile (signal)
├─ Wick/Body: Dominant wick + 30% body (direction-aligned)
├─ Stop Loss: min/max(VWAP, EMA21) ± 0.8-1.2x ATR
├─ Take Profit: 2.1:1
├─ Phantom Timeout: 8 hours
└─ Execution Frequency: Very High (multiple per hour)

Trend Pullback (15m, DISABLED):
├─ Pivot Detection: left=3, right=2
├─ Zone Width: 0.3% each side (0.6% total)
├─ S/R Breakout: Close outside zone
├─ Pullback: HL/LH within zone (stays above/below)
├─ Confirmation: 2 candles in trend direction
├─ Stop Loss: Same hybrid 3-option as MR
├─ Take Profit: 2.5:1 with fee compensation
├─ Phantom Timeout: 168 hours (1 week)
└─ Execution Frequency: Low (fewer S/R breakouts)

================================================================================
PERFORMANCE METRICS & MONITORING
================================================================================

Key Metrics:
├─ Win Rate: Target 50%+ (executed trades only)
├─ Phantom-to-Executed Ratio: Learning efficiency indicator
├─ Daily P&L: Cumulative performance
├─ Average R per Trade: Risk magnitude consistency
├─ Gate Pass Rate: Quality filtering effectiveness
├─ Execution Frequency: Signals per day/hour
└─ Phantom Accumulation: Active phantom count (health check)

Telegram Commands:
├─ /stats - Win rate, P&L, trade count
├─ /status - Open positions and PnL
├─ /ml_stats - Model training status
├─ /phantom_stats - Phantom tracking metrics
├─ /balance - Account equity
├─ /symbols - Active trading symbols
└─ /help - Command reference

Health Checks:
├─ Phantom Count: Alert if >100 active (outcome detection issue)
├─ Model Status: Check if trained (≥200 trades)
├─ Gate Effectiveness: Monitor if all gates blocking
├─ Regime Classification: Verify ATR/BBW calculations
├─ Telegram Connectivity: Test with /status command
└─ Database Persistence: Verify Redis/SQL connectivity

================================================================================
COMMON CONFIGURATION ADJUSTMENTS
================================================================================

Low Execution Frequency:
├─ Option 1: Reduce Qscore execute_q_min (78 → 70)
├─ Option 2: Enable phantom_flow relaxation (loosen gates)
├─ Option 3: Relax individual gate thresholds
└─ Option 4: Check if regime filter blocking all trades

Phantom Accumulation:
├─ Option 1: Increase timeout_hours (8 → 16 for scalp)
├─ Option 2: Reduce daily_caps (limit phantom flow)
├─ Option 3: Enable virtual_snapshots for better labeling
└─ Option 4: Check outcome detection (TP/SL hit logic)

High Slippage/Fees Impact:
├─ Note: Fee adjustment = 1.00165 (0.165% total)
├─ Auto-calculated in TP for target 2.5:1 net R:R
├─ Check: Order size vs available liquidity
└─ Adjust: Risk % if slippage consistently eating profits

Regime Filter Over-Blocking:
├─ Option 1: Set allowed_regimes to ['normal', 'high']
├─ Option 2: Increase atr_pct_max threshold
├─ Option 3: Increase bb_width_pct_max threshold
└─ Option 4: Disable during high-volatility market events

ML Model Not Training:
├─ Check: total_trades ≥ 50 (minimum for training)
├─ Check: Redis/database connectivity
├─ Check: Feature calculation (no NaN values)
├─ Verify: /ml_stats shows non-zero completed_trades
└─ Reset: python clear_ml_redis.py (if corrupted state)

================================================================================
FILE ORGANIZATION
================================================================================

Core Strategy Files:
├─ strategy_scalp.py (Scalp entry logic)
├─ strategy_mean_reversion.py (MR entry logic)
└─ strategy_pullback_ml_learning.py (Trend entry logic)

ML Scoring Files:
├─ ml_scorer_scalp.py (12-feature model)
├─ ml_scorer_mean_reversion.py (35+ features)
├─ ml_scorer_trend.py (22-feature model)
└─ ml_qscore_*_adapter.py (Quality scoring adapters)

Phantom Tracking Files:
├─ scalp_phantom_tracker.py (Scalp phantoms)
├─ mr_phantom_tracker.py (MR phantoms)
├─ phantom_trade_tracker.py (Trend phantoms)
└─ phantom_persistence.py (Redis storage)

Configuration Files:
├─ config.yaml (Master configuration)
├─ CLAUDE.md (Development instructions)
├─ STRATEGY_ANALYSIS.md (Detailed analysis)
└─ STRATEGY_QUICK_REFERENCE.md (Quick lookup)

================================================================================
TECHNICAL DETAILS
================================================================================

Fee Adjustment:
├─ Bybit Entry (Market): 0.06%
├─ Bybit Exit (Limit): 0.055%
├─ Slippage Estimate: 0.05%
└─ Total: 0.165% → multiplier 1.00165 for TP calculation

Stop Loss Minimums:
├─ Absolute: 1% of entry price
├─ Relative: 0.5%-0.6% from entry
└─ Prevents: Micro-stops in volatile candles

Risk Sizing:
├─ Risk Amount = Account Balance × Risk Percentage
├─ Quantity = Risk Amount / (Entry - SL)
├─ Rounded: To symbol tick size and minimum quantity
└─ Checked: Against leverage limits per symbol

ATR Calculations:
├─ True Range: max(H-L, |H-Close₋₁|, |L-Close₋₁|)
├─ ATR: 14-period average (configurable)
├─ Percentile: ranked against 100-bar history
└─ Used: For SL distances, volatility adjustment, feature scaling

VWAP (EVWAP) Calculation:
├─ Typical Price: (H + L + C) / 3
├─ EVWAP: EMA(TP × Vol) / EMA(Vol)
├─ Advantage: Faster adaptation than rolling VWAP
└─ Optional: Session-anchored variant (reset per session)

Bollinger Bands:
├─ Midline: 20-period SMA
├─ Std Dev: 20-period standard deviation
├─ Bands: Mid ± 2 × StdDev
├─ Width: (Upper - Lower) / Mid × 100%
├─ Percentile: ranked against recent width history
└─ Used: Volume spike correlation, volatility assessment

EMA (Exponential Moving Average):
├─ Fast (Scalp): 8-period
├─ Slow (Scalp): 21-period
├─ Long-term (Trend): 200-period
└─ Used: Trend confirmation, support/resistance identification

================================================================================
DEPLOYMENT & TESTING
================================================================================

Running the Bot:
├─ python live_bot.py (Standard execution)
├─ RISK_USD=10 python live_bot.py (Override risk USD)
├─ RISK_PERCENT=3 python live_bot.py (Override risk %)
└─ Environment: .env file with API keys and credentials

Testing Commands:
├─ python test_ml_integration.py (ML system test)
├─ python test_phantom_collection.py (Phantom tracking test)
├─ python test_enhanced_strategy.py (Strategy components)
├─ python check_all_symbols.py (Symbol connectivity)
└─ python fetch_symbol_specs.py (Symbol specifications)

ML Management:
├─ python clear_ml_redis.py (Reset ML data)
├─ python force_reset_ml.py (Complete model reset)
├─ python check_ml_state.py (ML status check)
└─ python reset_all_stats.py (Trading statistics reset)

Symbol Management:
├─ python get_top_50_marketcap.py (Fetch top 50)
├─ python get_top_100_marketcap.py (Fetch top 100)
├─ python get_top_250_marketcap.py (Fetch top 250)
└─ python update_by_marketcap.py (Update config)

================================================================================
CONCLUSION
================================================================================

The AutoTrading Bot implements a sophisticated, data-driven trading system with:

✓ Three complementary strategies (Trend, MR, Scalp)
✓ Dual-tier execution (ML-based + rule-based quality scoring)
✓ Phantom tracking for continuous ML learning
✓ Adaptive phantom flow control
✓ Volatility-adjusted risk management
✓ Multi-timeframe context awareness
✓ Feature engineering at scale (12-35+ features per signal)
✓ Execution gates for quality filtering
✓ Real-time Telegram monitoring and control

Current Status:
├─ Mean Reversion: ENABLED (High setup frequency)
├─ Scalping: ENABLED (Very high setup frequency)
└─ Trend Pullback: DISABLED (Phantom learning mode)

The system is designed for continuous improvement through phantom-based learning,
with ML models automatically training after sufficient data collection (50+ trades
per strategy) and threshold optimization based on actual win rates.

================================================================================
